<!-- tbot_web/templates/ledger.html -->

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Ledger Reconciliation</title>
    <link rel="stylesheet" href="/static/css/base/normalize.css">
    <link rel="stylesheet" href="/static/css/base/layout.css">
    <link rel="stylesheet" href="/static/css/shared/forms.css">
    <link rel="stylesheet" href="/static/css/components/buttons.css">
    <link rel="stylesheet" href="/static/css/pages/ledger.css">
    <style>
      .ledger-table td, .ledger-table th { padding: 4px 6px; vertical-align: top; }
      .ledger-table .row-top { background: #f8f8fa; }
      .ledger-table .row-bottom { background: #f3f3f5; }
      .ledger-table .action-cell { white-space: nowrap; }
      .sortable:hover { cursor: pointer; background: #e6e6f3; }
      .sort-asc::after { content: " ▲"; }
      .sort-desc::after { content: " ▼"; }
      .collapse-btn { cursor: pointer; color: #0040c0; text-decoration: underline; background: none; border: none; padding: 0 6px; }
      .expand-toggle { margin-left:.5rem; font-size: .9em; color:#333; }
      .toolbar { display:flex; align-items:center; gap:1rem; margin:.75rem 0; }
      .toolbar .right { margin-left:auto; display:flex; gap:.75rem; align-items:center; }
      .status-mismatch { color:#b30000; font-weight:600; }
      .resolved-tag { color:#0a7; font-weight:600; }
      .status-ok { color:#333; }
      .balance-table th, .balance-table td { padding: 4px 6px; }
      .btn-link { display:inline-block; padding:.5rem .75rem; border:1px solid #ccc; border-radius:6px; background:#fafafa; text-decoration:none; color:#222; }
      .btn-link:hover { background:#f0f0f6; }
      .subnote { font-size:.85em; color:#666; }
    </style>
    <script src="/static/js/ledger.js"></script>
</head>
<body>
  <div class="header">
    <h1>Ledger Reconciliation</h1>
  </div>

  <div class="main-container">
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <ul class="flashes">
          {% for category, message in messages %}
            <li class="{{ category }}">{{ message }}</li>
          {% endfor %}
        </ul>
      {% endif %}
    {% endwith %}

    {% if error %}
      <div class="error-message" style="color:#b30000; margin:1em 0 2em 0;">{{ error }}</div>
    {% endif %}

    <div class="toolbar">
      <form id="syncLedgerForm" method="post" action="{{ url_for('ledger_web.ledger_sync') }}">
        <button type="submit">Sync Broker Ledger</button>
      </form>

      <a class="btn-link" href="{{ url_for('coa_mapping_web.view_mapping') }}">Open COA Mapping</a>

      <div class="right">
        <!-- Master collapse/expand toggle: checked = collapse all -->
        <label>
          <input type="checkbox" id="collapse-all" />
          Collapse all
        </label>
      </div>
    </div>

    <div class="reconcile-container">
      <h2>Reconciliation Table</h2>

      <table class="ledger-table">
        <thead>
          <tr>
            <th class="sortable" data-col="datetime_utc" onclick="sortLedgerTable('datetime_utc')">DTPOSTED (UTC)</th>
            <th class="sortable" data-col="symbol" onclick="sortLedgerTable('symbol')">Symbol</th>
            <!-- Representative leg account for collapsed/top row -->
            <th class="sortable" data-col="account" onclick="sortLedgerTable('account')">Account (COA path)</th>
            <th class="sortable" data-col="trntype" onclick="sortLedgerTable('trntype')">TRNTYPE</th>
            <th class="sortable" data-col="action" onclick="sortLedgerTable('action')">Action</th>
            <th class="sortable" data-col="quantity" onclick="sortLedgerTable('quantity')">Quantity</th>
            <th class="sortable" data-col="price" onclick="sortLedgerTable('price')">Price</th>
            <th class="sortable" data-col="fee" onclick="sortLedgerTable('fee')">Fee</th>
            <th class="sortable" data-col="total_value" onclick="sortLedgerTable('total_value')">Amount</th>
            <th class="sortable" data-col="status" onclick="sortLedgerTable('status')">Status</th>
            <th class="sortable" data-col="running_balance" onclick="sortLedgerTable('running_balance')">Running Balance</th>
          </tr>
          <tr>
            <th>Trade ID</th>
            <th>Account</th>
            <th>Strategy</th>
            <th>Tags</th>
            <th>Notes</th>
            <th>Side</th>
            <th colspan="5" class="subnote">Expanded rows show per-leg COA account & side</th>
          </tr>
        </thead>

        <tbody id="ledger-tbody">
          {% for entry in entries %}
            {% if (entry.symbol and entry.symbol|string|trim) or
                  (entry.datetime_utc and entry.datetime_utc|string|trim) or
                  (entry.timestamp_utc and entry.timestamp_utc|string|trim) or
                  (entry.action and entry.action|string|trim) or
                  (entry.price is not none and entry.price|string not in ("", "None")) or
                  (entry.quantity is not none and entry.quantity|string not in ("", "None")) or
                  (entry.total_value is not none and entry.total_value|string not in ("", "None"))
            %}
              <!-- Top (representative / collapsed) row -->
              <tr class="row-top {{ entry.status }}">
                <td>
                  <button
                    class="collapse-btn"
                    type="button"
                    onclick="toggleCollapse('{{ entry.group_id or entry.trade_id }}', {{ 'true' if entry.collapsed else 'false' }})"
                    title="{{ 'Expand' if entry.collapsed else 'Collapse' }}">
                    {{ "+" if entry.collapsed else "−" }}
                  </button>
                  {{ (entry.timestamp_utc or entry.datetime_utc or entry.created_at_utc)[:19] if (entry.timestamp_utc or entry.datetime_utc or entry.created_at_utc) }}
                </td>
                <td>{{ entry.symbol or "" }}</td>
                <td>{{ entry.account or "" }}</td>
                <td>{{ entry.trntype or entry.type or "" }}</td>
                <td>{{ entry.action or "" }}</td>
                <td>{{ entry.quantity or "" }}</td>
                <td>{{ entry.price or "" }}</td>
                <td>{{ entry.fee or "" }}</td>
                <td>{{ entry.total_value or "" }}</td>
                <td>
                  {% if entry.status == "mismatch" %}
                    <span class="status-mismatch">Mismatch</span>
                  {% elif entry.status == "resolved" %}
                    <span class="resolved-tag">Resolved</span>
                  {% else %}
                    <span class="status-ok">OK</span>
                  {% endif %}
                </td>
                <td>{{ entry.running_balance if entry.running_balance is defined else "" }}</td>
              </tr>

              <!-- Expanded sub-entries for collapsed groups -->
              {% if entry.collapsed and entry.sub_entries %}
                {% for sub in entry.sub_entries %}
                  <tr class="row-bottom {{ sub.status }}">
                    <td>{{ sub.trade_id or "" }}</td>
                    <td>
                      {{ sub.account or "" }}
                    </td>
                    <td>{{ sub.strategy or "" }}</td>
                    <td>{{ sub.tags or "" }}</td>
                    <td>{{ sub.notes or "" }}</td>
                    <td>{{ sub.side or "" }}</td>
                    <td colspan="5" class="subnote">
                      DTPOSTED: {{ (sub.timestamp_utc or sub.datetime_utc or sub.created_at_utc)[:19] if (sub.timestamp_utc or sub.datetime_utc or sub.created_at_utc) }}
                      &nbsp; • &nbsp; TRNTYPE: {{ sub.trntype or sub.type or "" }}
                      &nbsp; • &nbsp; Amount: {{ sub.total_value or "" }}
                    </td>
                  </tr>
                {% endfor %}
              {% endif %}
            {% endif %}
          {% endfor %}

          <!-- Add-entry rows -->
          <tr class="row-top">
            <form method="post" action="{{ url_for('ledger_web.add_ledger_entry_route') }}">
              <td><input type="text" name="datetime_utc" placeholder="YYYY-MM-DDTHH:MM:SSZ" required></td>
              <td><input type="text" name="symbol" placeholder="Symbol"></td>
              <td><!-- Account shown in bottom add-row --></td>
              <td>
                <input type="text" name="action" placeholder="TRNTYPE/Action (e.g., long, short, fee)">
              </td>
              <td><input type="text" name="quantity" placeholder="Qty"></td>
              <td><input type="text" name="price" placeholder="Price"></td>
              <td><input type="text" name="fee" placeholder="Fee"></td>
              <td><input type="text" name="total_value" placeholder="Amount"></td>
              <td></td>
              <td></td>
          </tr>
          <tr class="row-bottom">
              <td><input type="text" name="trade_id" placeholder="Trade ID / Group"></td>
              <td>
                <select name="account" required>
                  <option value="">Select Account</option>
                  {% for code, name in coa_accounts %}
                    <option value="{{ code }}">{{ name }} ({{ code }})</option>
                  {% endfor %}
                </select>
              </td>
              <td>
                <select name="strategy">
                  <option value="">NONE</option>
                  <option value="open">open</option>
                  <option value="mid">mid</option>
                  <option value="close">close</option>
                  <option value="other">other</option>
                </select>
              </td>
              <td><input type="text" name="tags" placeholder="Tags"></td>
              <td><input type="text" name="notes" placeholder="Notes"></td>
              <td colspan="2">
                <button type="submit" class="add-btn">Add Entry</button>
              </td>
              <td colspan="3"></td>
            </form>
          </tr>
        </tbody>
      </table>

      <div class="ledger-balance-summary" style="margin-top:1.5rem;">
        <h3>Account Balances</h3>
        {% if balances %}
          <table class="balance-table">
            <thead>
              <tr>
                <th>Account</th>
                <th>Opening</th>
                <th>Debits</th>
                <th>Credits</th>
                <th>Closing</th>
              </tr>
            </thead>
            <tbody>
              {% for acct, vals in balances.items() %}
                <tr>
                  <td>{{ acct }}</td>
                  <td>{{ vals.opening_balance if vals.opening_balance is defined else vals['opening_balance'] }}</td>
                  <td>{{ vals.debits if vals.debits is defined else vals['debits'] }}</td>
                  <td>{{ vals.credits if vals.credits is defined else vals['credits'] }}</td>
                  <td>{{ vals.closing_balance if vals.closing_balance is defined else vals['closing_balance'] }}</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        {% else %}
          <p>No balance data available.</p>
        {% endif %}
        <p class="subnote">Closing = Opening + Debits − Credits (all values as of DTPOSTED window).</p>
      </div>

      <div class="audit-log-info" style="margin-top:1rem;">
        <p>All edits, resolutions, and reconciliation actions are logged with UTC timestamp and user ID for compliance.</p>
        <p>Only admin users can resolve or edit ledger entries.</p>
      </div>
    </div>
  </div>
</body>
</html>
