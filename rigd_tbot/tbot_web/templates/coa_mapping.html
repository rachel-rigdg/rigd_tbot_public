<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>COA Mapping Table</title>
    <link rel="stylesheet" href="/static/css/base/normalize.css">
    <link rel="stylesheet" href="/static/css/base/layout.css">
    <link rel="stylesheet" href="/static/css/shared/forms.css">
    <link rel="stylesheet" href="/static/css/components/buttons.css">
</head>
<body>
<div class="container coa-mapping-container">
  <h1>Chart of Accounts Mapping</h1>

  <!-- Context-aware deep link support (from ledger) -->
  <div id="context-banner" class="context-banner" style="display:none;"></div>

  <div class="coa-mapping-toolbar">
    <form method="get" action="{{ url_for('coa_mapping_web.api_export') }}">
      <button type="submit" class="btn btn-info btn-sm">Export Mapping (JSON)</button>
    </form>
    <form method="post" action="{{ url_for('coa_mapping_web.api_import') }}" enctype="multipart/form-data">
      <input type="file" name="file" required>
      <button type="submit" class="btn btn-info btn-sm">Import Mapping</button>
    </form>
    <a class="btn btn-secondary btn-sm" href="{{ url_for('coa_mapping_web.api_versions') }}" target="_blank">View Versions (JSON)</a>
  </div>

  <div class="layout-split">
    <!-- LEFT: CRUD table -->
    <div>
      <div class="filter-bar">
        <input type="text" id="flt-broker" placeholder="Filter broker…">
        <input type="text" id="flt-type" placeholder="Filter type…">
        <input type="text" id="flt-subtype" placeholder="Filter subtype…">
        <input type="text" id="flt-desc" placeholder="Filter description…">
        <button type="button" class="btn btn-sm" id="btn-clear-filters">Clear</button>
      </div>
      <div class="click-help">Tip: click a row to prefill the form for quick edits; submit to upsert the rule.</div>

      <form method="post" action="{{ url_for('coa_mapping_web.api_assign') }}" id="coa-mapping-form">
        <table class="coa-mapping-table">
          <thead>
            <tr>
              <th>Broker</th>
              <th>Type</th>
              <th>Subtype</th>
              <th>Description</th>
              <th>Debit Account</th>
              <th>Credit Account</th>
              <th>Last Updated</th>
              <th>Updated By</th>
            </tr>
          </thead>
          <tbody id="mapping-tbody">
            {% set _rows = (mapping.table or mapping_rows) %}
            {% for row in _rows %}
            <tr class="mapping-row"
                id="rule-{{ loop.index }}"
                data-broker="{{ row.broker }}"
                data-type="{{ row.type }}"
                data-subtype="{{ row.subtype or '' }}"
                data-description="{{ row.description or '' }}">
              <td><input type="text" value="{{ row.broker }}" readonly></td>
              <td><input type="text" value="{{ row.type }}" readonly></td>
              <td><input type="text" value="{{ row.subtype or '' }}" readonly></td>
              <td><input type="text" value="{{ row.description or '' }}" readonly></td>
              <td><input type="text" value="{{ row.debit_account or row.coa_account or '' }}" readonly></td>
              <td><input type="text" value="{{ row.credit_account or '' }}" readonly></td>
              <td>{{ row.updated_at or '' }}</td>
              <td>{{ row.updated_by or '' }}</td>
            </tr>
            {% endfor %}
            <tr>
              <td><input type="text" name="broker" id="f-broker" placeholder="Broker" required></td>
              <td><input type="text" name="type" id="f-type" placeholder="Type" required></td>
              <td><input type="text" name="subtype" id="f-subtype" placeholder="Subtype"></td>
              <td><input type="text" name="description" id="f-desc" placeholder="Description"></td>
              <!-- Single source of truth for assignment: coa_account -->
              <td><input type="text" name="coa_account" id="f-coa" placeholder="COA Account" required></td>
              <td><input type="text" name="credit_account" id="f-credit" placeholder="(optional)"></td>
              <td colspan="2">
                <input type="hidden" name="reason" value="manual assignment">
                <button type="submit" class="btn btn-success btn-sm">Add / Update Mapping</button>
              </td>
            </tr>
          </tbody>
        </table>
      </form>

      <div class="coa-mapping-audit-info">
        <p>All mapping assignments, edits, rollbacks, and imports are audit-logged by user and UTC timestamp per compliance.</p>
        <p>COA mapping controls posting logic, double-entry compliance, and ledger account assignment for all broker syncs.</p>
      </div>
    </div>

    <!-- RIGHT: Versions (AJAX), with rollback actions -->
    <aside class="versions-panel">
      <h2>Mapping Versions</h2>
      <ul id="versions-list" class="versions-list"></ul>
    </aside>
  </div>
</div>

<script>
(function() {
  const qs = new URLSearchParams(window.location.search);
  const from = qs.get('from');
  const entryId = qs.get('entry_id');
  const ctxBroker = qs.get('broker');
  const ctxType = qs.get('type');
  const ctxSubtype = qs.get('subtype');
  const ctxDesc = qs.get('description');

  // Context banner
  const banner = document.getElementById('context-banner');
  if (from === 'ledger') {
    let msg = 'Opened from Ledger';
    if (entryId) msg += ` — entry #${entryId}`;
    banner.textContent = msg + '. If fields below were supplied, matching rule is highlighted.';
    banner.style.display = 'block';
  }

  const tbody = document.getElementById('mapping-tbody');

  // Build one row element from a JSON rule
  function buildRow(r, idx) {
    const tr = document.createElement('tr');
    tr.className = 'mapping-row';
    tr.id = 'rule-' + (idx + 1);
    const broker = (r.broker || '').trim();
    const typ = (r.type || '').trim();
    const sub = (r.subtype || '').trim();
    const desc = (r.description || '').trim();
    const debit = (r.debit_account || r.coa_account || '').trim();
    const credit = (r.credit_account || '').trim();
    tr.dataset.broker = broker;
    tr.dataset.type = typ;
    tr.dataset.subtype = sub;
    tr.dataset.description = desc;
    tr.innerHTML = `
      <td><input type="text" value="${broker}" readonly></td>
      <td><input type="text" value="${typ}" readonly></td>
      <td><input type="text" value="${sub}" readonly></td>
      <td><input type="text" value="${desc}" readonly></td>
      <td><input type="text" value="${debit}" readonly></td>
      <td><input type="text" value="${credit}" readonly></td>
      <td>${r.updated_at || ''}</td>
      <td>${r.updated_by || ''}</td>
    `;
    return tr;
  }

  // Fetch and render mapping rows
  function loadMappingRows() {
    fetch('{{ url_for("coa_mapping_web.mapping_table_api") }}')
      .then(r => r.ok ? r.json() : Promise.reject(r))
      .then(payload => {
        if (!payload || payload.ok !== true) throw new Error('bad response');
        const rows = Array.isArray(payload.rows) ? payload.rows : [];
        // Preserve the final input row (the upsert form) while replacing existing SSR rows
        const inputRow = tbody.lastElementChild; // the form row
        // Remove all existing data rows except the last input row
        while (tbody.children.length > 1) {
          tbody.removeChild(tbody.firstElementChild);
        }
        // Insert fetched rows before the input row
        rows.forEach((r, i) => tbody.insertBefore(buildRow(r, i), inputRow));
        applyFilters();
        highlightByContext();
      })
      .catch(() => {
        // leave SSR content if fetch fails
      });
  }

  // Highlight matching rule if context keys provided
  function highlightByContext() {
    if (!(ctxBroker || ctxType || ctxSubtype || ctxDesc)) return;
    const rows = document.querySelectorAll('.mapping-row');
    for (const r of rows) {
      const ok =
        (!ctxBroker || r.dataset.broker === ctxBroker) &&
        (!ctxType || r.dataset.type === ctxType) &&
        (!ctxSubtype || r.dataset.subtype === ctxSubtype) &&
        (!ctxDesc || r.dataset.description === ctxDesc);
      if (ok) {
        r.classList.add('row-highlight');
        r.scrollIntoView({ behavior: 'smooth', block: 'center' });
        break;
      }
    }
  }

  // Prefill form when clicking an existing rule row
  const form = document.getElementById('coa-mapping-form');
  const f = {
    broker: document.getElementById('f-broker'),
    type: document.getElementById('f-type'),
    subtype: document.getElementById('f-subtype'),
    desc: document.getElementById('f-desc'),
    coa: document.getElementById('f-coa'),
    credit: document.getElementById('f-credit')
  };
  tbody?.addEventListener('click', function(ev) {
    const tr = ev.target.closest('.mapping-row');
    if (!tr) return;
    const cells = tr.querySelectorAll('td input');
    f.broker.value = (cells[0]?.value || '');
    f.type.value = (cells[1]?.value || '');
    f.subtype.value = (cells[2]?.value || '');
    f.desc.value = (cells[3]?.value || '');
    // Prefer displayed Debit as the single COA account; fallback to Credit if Debit empty
    f.coa.value = (cells[4]?.value || cells[5]?.value || '');
    f.credit.value = (cells[5]?.value || '');
    f.coa.focus();
  });

  // Client-side filters
  function applyFilters() {
    const fb = document.getElementById('flt-broker').value.toLowerCase();
    const ft = document.getElementById('flt-type').value.toLowerCase();
    const fs = document.getElementById('flt-subtype').value.toLowerCase();
    const fd = document.getElementById('flt-desc').value.toLowerCase();
    document.querySelectorAll('.mapping-row').forEach(r => {
      const v =
        (r.dataset.broker || '').toLowerCase().includes(fb) &&
        (r.dataset.type || '').toLowerCase().includes(ft) &&
        (r.dataset.subtype || '').toLowerCase().includes(fs) &&
        (r.dataset.description || '').toLowerCase().includes(fd);
      r.style.display = v ? '' : 'none';
    });
  }
  ['flt-broker','flt-type','flt-subtype','flt-desc'].forEach(id => {
    document.getElementById(id).addEventListener('input', applyFilters);
  });
  document.getElementById('btn-clear-filters').addEventListener('click', () => {
    ['flt-broker','flt-type','flt-subtype','flt-desc'].forEach(id => document.getElementById(id).value = '');
    applyFilters();
  });

  // Versions loader + rollback
  function loadVersions() {
    fetch('{{ url_for("coa_mapping_web.api_versions") }}')
      .then(r => r.ok ? r.json() : Promise.reject(r))
      .then(payload => {
        if (!payload || payload.ok !== true) throw new Error('bad response');
        const history = Array.isArray(payload.history) ? payload.history : [];
        const ul = document.getElementById('versions-list');
        ul.innerHTML = '';
        history.forEach(v => {
          const li = document.createElement('li');
          const left = document.createElement('div');
          left.innerHTML = `<strong>v${v.version || ''}</strong><br><small>${v.timestamp_utc || ''}</small>`;
          const btn = document.createElement('button');
          btn.className = 'btn btn-warning btn-sm';
          btn.textContent = 'Rollback';
          btn.addEventListener('click', () => {
            const fd = new FormData();
            fd.append('version', v.version);
            fetch('{{ url_for("coa_mapping_web.api_rollback") }}', { method:'POST', body: fd })
              .then(r => r.ok ? r.json() : Promise.reject(r))
              .then(resp => {
                if (resp && resp.ok) location.reload();
                else throw new Error('rollback failed');
              })
              .catch(() => alert('Rollback failed'));
          });
          li.appendChild(left);
          li.appendChild(btn);
          ul.appendChild(li);
        });
      })
      .catch(() => {
        const ul = document.getElementById('versions-list');
        ul.innerHTML = '<li><small>Failed to load versions.</small></li>';
      });
  }

  // Initializers
  applyFilters();
  loadVersions();
  loadMappingRows();
})();
</script>
</body>
</html>
