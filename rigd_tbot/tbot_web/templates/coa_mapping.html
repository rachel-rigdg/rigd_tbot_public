<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>COA Mapping Table</title>
  <link rel="stylesheet" href="/static/css/base/normalize.css">
  <link rel="stylesheet" href="/static/css/base/layout.css">
  <link rel="stylesheet" href="/static/css/shared/forms.css">
  <link rel="stylesheet" href="/static/css/components/buttons.css">
  <link rel="stylesheet" href="/static/css/pages/coa_mapping.css">
  <style>
    .wrap { max-width: 1100px; margin: 0 auto; }
    .toolbar { display:flex; flex-wrap:wrap; gap:.75rem; align-items:center; margin:.75rem 0 1rem; }
    .toolbar form { display:inline-flex; gap:.5rem; align-items:center; }
    .meta { font-size:.9em; color:#555; margin:.25rem 0 1rem; }
    h2 { margin-top:1.25rem; }
    .table { width:100%; border-collapse: collapse; }
    .table th, .table td { padding: 6px 8px; border-bottom: 1px solid #e8e8ee; vertical-align: top; }
    .table th { text-align:left; background:#fafafe; }
    .pill { display:inline-block; padding:.1rem .4rem; border-radius:.4rem; font-size:.85em; background:#eef; color:#223; }
    .muted { color:#777; font-size:.9em; }
    .code { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
    .col-tight { white-space: nowrap; }
    .ok { color: #0a7; }
    .warn { color: #b36b00; }
    .danger { color: #b30000; }
    .section-note { font-size:.9em; color:#666; margin:.25rem 0 .75rem; }
    .btn-xs { padding:.3rem .45rem; font-size:.85em; }
    .grid { display:grid; grid-template-columns: repeat(6, 1fr); gap:.5rem; }
    .grid .span-2 { grid-column: span 2; }
    .grid .span-3 { grid-column: span 3; }
    .grid .span-6 { grid-column: span 6; }
    .inline-form { display:inline; }
    .readonly { background:#f8f8fa; }
  </style>
</head>
<body>
<div class="wrap">

  <h1>Chart of Accounts Mapping</h1>

  <!-- meta/version line -->
  <div class="meta">
    <span class="pill">Version v{{ mapping.meta.version_id if mapping.meta and mapping.meta.version_id is defined else mapping.version }}</span>
    &nbsp;•&nbsp; Updated:
    <span class="code">{{ mapping.meta.updated_at_utc if mapping.meta and mapping.meta.updated_at_utc else '' }}</span>
    &nbsp;•&nbsp; Identity:
    <span class="code">
      {{ mapping.meta.entity_code }}/{{ mapping.meta.jurisdiction_code }}/{{ mapping.meta.broker_code }}
    </span>
  </div>

  <!-- toolbar -->
  <div class="toolbar">
    <form method="get" action="{{ url_for('coa_mapping_web.export_mapping') }}">
      <button type="submit" class="btn">Export Mapping (JSON)</button>
    </form>

    <form method="post" action="{{ url_for('coa_mapping_web.import_mapping') }}" enctype="multipart/form-data">
      <input type="file" name="file" required>
      <button type="submit" class="btn">Import Mapping</button>
    </form>

    <form method="get" action="{{ url_for('coa_mapping_web.list_versions') }}">
      <button type="submit" class="btn btn-secondary">View Versions (JSON)</button>
    </form>
  </div>

  <!-- ACTIVE MAPPINGS -->
  <h2>Active Mapping Rules</h2>
  <p class="section-note">Active, append-only rows. New assignments deactivate older rows with the same <span class="code">code</span>.</p>
  <table class="table">
    <thead>
      <tr>
        <th class="col-tight">Code</th>
        <th>Match (broker / type / subtype / description)</th>
        <th>Debit Account</th>
        <th>Credit Account</th>
        <th class="col-tight">Version</th>
        <th class="col-tight">Updated</th>
        <th class="col-tight">By</th>
        <th>Reason</th>
      </tr>
    </thead>
    <tbody>
      {% for r in mapping.rows if r.active %}
      <tr>
        <td class="code col-tight">{{ r.code }}</td>
        <td>
          <div class="code">
            {{ r.match.broker or '' }} /
            {{ r.match.type or '' }} /
            {{ r.match.subtype or '' }} /
            {{ r.match.description or '' }}
          </div>
        </td>
        <td class="code">{{ r.debit_account }}</td>
        <td class="code">{{ r.credit_account }}</td>
        <td class="col-tight">{{ r.version_id }}</td>
        <td class="col-tight">{{ r.updated_at_utc }}</td>
        <td class="col-tight">{{ r.updated_by }}</td>
        <td class="muted">{{ r.reason or '' }}</td>
      </tr>
      {% else %}
      <tr><td colspan="8" class="muted">No active mappings yet.</td></tr>
      {% endfor %}
    </tbody>
  </table>

  <!-- ADD / UPDATE MAPPING -->
  <h2>Add / Update Mapping</h2>
  <p class="section-note">
    Adding a rule appends a new row and deactivates prior active rows with the same <span class="code">code</span>
    (derived from the match fields if not provided).
  </p>

  <form method="post" action="{{ url_for('coa_mapping_web.assign_mapping_route') }}" id="assign-form">
    <div class="grid">
      <div>
        <label>Broker</label>
        <input type="text" name="broker" placeholder="e.g. alpaca" required>
      </div>
      <div>
        <label>Type</label>
        <input type="text" name="type" placeholder="e.g. trade" required>
      </div>
      <div>
        <label>Subtype</label>
        <input type="text" name="subtype" placeholder="optional">
      </div>
      <div class="span-3">
        <label>Description</label>
        <input type="text" name="description" placeholder="optional (exact match)">
      </div>

      <div class="span-3">
        <label>Debit Account</label>
        <input type="text" name="debit_account" placeholder="e.g. 1110-Cash" required>
      </div>
      <div class="span-3">
        <label>Credit Account</label>
        <input type="text" name="credit_account" placeholder="e.g. 4090-Revenue" required>
      </div>
      <div class="span-2">
        <label>Reason</label>
        <input type="text" name="reason" placeholder="manual assignment">
      </div>
      <div class="span-6">
        <button type="submit" class="btn btn-success">Save Mapping</button>
      </div>
    </div>
  </form>

  <!-- UNMAPPED QUEUE -->
  <h2>Flagged Unmapped Transactions</h2>
  <p class="section-note">Submitted by sync/reconcile for review. Click “Map this” to prefill the form above.</p>
  <table class="table">
    <thead>
      <tr>
        <th>When</th>
        <th>Broker</th>
        <th>Type</th>
        <th>Subtype</th>
        <th>Description</th>
        <th class="col-tight">Action</th>
      </tr>
    </thead>
    <tbody>
      {% for u in mapping.unmapped %}
      {% set t = u.transaction or {} %}
      <tr>
        <td class="col-tight">{{ u.flagged_at_utc }}</td>
        <td class="code">{{ t.broker or '' }}</td>
        <td class="code">{{ t.type or '' }}</td>
        <td class="code">{{ t.subtype or '' }}</td>
        <td class="code">{{ t.description or '' }}</td>
        <td class="col-tight">
          <button class="btn btn-xs" type="button"
                  onclick="prefillAssign('{{ t.broker|e }}','{{ t.type|e }}','{{ (t.subtype or '')|e }}','{{ (t.description or '')|e }}')">
            Map this
          </button>
        </td>
      </tr>
      {% else %}
      <tr><td colspan="6" class="muted">No unmapped transactions queued.</td></tr>
      {% endfor %}
    </tbody>
  </table>

  <!-- VERSION HISTORY + ROLLBACK -->
  <h2>Version History</h2>
  <p class="section-note">
    Each save/import creates a snapshot. Rollback writes the snapshot over the live table as a new version.
  </p>
  <table class="table">
    <thead>
      <tr>
        <th class="col-tight">Version</th>
        <th class="col-tight">Timestamp (UTC)</th>
        <th class="col-tight">User</th>
        <th>Reason</th>
        <th class="col-tight">Rows</th>
        <th class="col-tight">Rollback</th>
      </tr>
    </thead>
    <tbody>
      {% for h in (mapping.history or [])|reverse %}
      <tr>
        <td class="col-tight"><span class="pill">v{{ h.version_id }}</span></td>
        <td class="col-tight">{{ h.timestamp_utc }}</td>
        <td class="col-tight">{{ h.user }}</td>
        <td class="muted">{{ h.reason or '' }}</td>
        <td class="col-tight">{{ h.row_count }}</td>
        <td class="col-tight">
          <form class="inline-form" method="post" action="{{ url_for('coa_mapping_web.rollback_mapping') }}">
            <input type="hidden" name="version" value="{{ h.version_id }}">
            <button type="submit" class="btn btn-warning btn-xs">Rollback</button>
          </form>
        </td>
      </tr>
      {% else %}
      <tr><td colspan="6" class="muted">No history yet.</td></tr>
      {% endfor %}
    </tbody>
  </table>

  <div class="coa-mapping-audit-info">
    <p>All mapping assignments, imports, and rollbacks are audit-logged with immutable snapshots for compliance.</p>
  </div>

</div>

<script>
  // Prefill the "Add / Update Mapping" form from an unmapped row
  function prefillAssign(broker, type, subtype, description) {
    const f = document.getElementById('assign-form');
    if (!f) return;
    f.querySelector('input[name="broker"]').value = broker || '';
    f.querySelector('input[name="type"]').value = type || '';
    f.querySelector('input[name="subtype"]').value = subtype || '';
    f.querySelector('input[name="description"]').value = description || '';
    // Focus debit account to nudge completion
    const da = f.querySelector('input[name="debit_account"]');
    if (da) da.focus();
    window.scrollTo({ top: f.getBoundingClientRect().top + window.scrollY - 12, behavior: 'smooth' });
  }
</script>
</body>
</html>
