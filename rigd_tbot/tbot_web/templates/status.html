<!-- tbot_web/templates/status.html -->
<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>TradeBot Status Dashboard</title>
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="stylesheet" href="/static/css/base/normalize.css">
        <link rel="stylesheet" href="/static/css/base/layout.css">
        <link rel="stylesheet" href="/static/css/shared/forms.css">
        <link rel="stylesheet" href="/static/css/components/buttons.css">
        <link rel="stylesheet" href="/static/css/pages/status.css">
        <script src="/static/js/status_live.js" defer></script>
    </head>
<body>
    <div class="main-container">
        <div style="width:70%; margin-left:auto; margin-right:auto;">
            <h1>TradeBot Status</h1>
            {% if status.test_mode_active %}
              <div style="margin:8px 0; padding:6px 10px; background:#ffecec; border:1px solid #e99; color:#900; border-radius:6px;">
                <strong>TEST MODE ACTIVE</strong>
                <form method="post" action="/test/clear" style="display:inline;">
                  <button type="submit" style="margin-left:10px;">Clear Test Mode</button>
                </form>
              </div>
            {% endif %}
            <p style="margin-top:-6px;color:#666;">
                Orchestration: <strong>daily one-shot supervisor</strong> (systemd timer @ <code>00:01 UTC</code>).
            </p>

            <!-- NEW: Top-line clarity row (TEST MODE badge, Provider state, Universe size) -->
            <div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin:10px 0 6px 0;">
                <span id="badge-testmode" style="display:none;"></span>
                <span id="provider-state" style="color:#666;"></span>
                <span id="universe-size" style="color:#666;"></span>
            </div>

            <!-- Supervisor banner (pure-template logic; no backend change required) -->
            <div style="margin:14px 0;padding:10px 12px;border-radius:6px;background:#f7f7f7;border:1px solid #e2e2e2;">
                {% set sup_from_status = status.supervisor_state if status and status.supervisor_state is defined else None %}
                {% if sup_from_status %}
                    {% if sup_from_status|lower == "running" %}
                        <strong style="color:green;">Supervisor running.</strong>
                    {% elif sup_from_status|lower == "launched" %}
                        <strong style="color:#2a7;">Supervisor launched.</strong>
                    {% elif sup_from_status|lower == "scheduled" %}
                        <strong style="color:#444;">Supervisor scheduled.</strong>
                    {% elif sup_from_status|lower == "failed" %}
                        <strong style="color:red;">Supervisor failed.</strong>
                    {% else %}
                        <strong style="color:#666;">Supervisor: {{ sup_from_status }}</strong>
                    {% endif %}
                {% else %}
                    {% if schedule %}
                        <!-- If a schedule.json is present, we can at least say "scheduled" -->
                        <strong style="color:#444;">Supervisor scheduled.</strong>
                        {% if status and status.state in ["analyzing","trading","updating"] %}
                            <span style="margin-left:8px;color:green;font-weight:bold;">Supervisor running.</span>
                        {% elif status and status.state == "error" %}
                            <span style="margin-left:8px;color:red;font-weight:bold;">Supervisor failed.</span>
                        {% endif %}
                    {% else %}
                        <!-- No schedule yet; try to infer from bot state -->
                        {% if status and status.state in ["analyzing","trading","updating"] %}
                            <strong style="color:green;">Supervisor running.</strong>
                        {% elif status and status.state == "error" %}
                            <strong style="color:red;">Supervisor failed.</strong>
                        {% else %}
                            <strong style="color:#666;">Supervisor not scheduled yet.</strong>
                        {% endif %}
                    {% endif %}
                {% endif %}
            </div>

            {% if status.error %}
                <p class="error">{{ status.error }}</p>
            {% else %}
                <!-- ======================== NEW: CLOCK BAR ======================== -->
                <div class="clock-bar" style="display:flex;gap:16px;align-items:center;margin:6px 0 2px 0;padding:6px 10px;border:1px solid #e2e2e2;border-radius:6px;background:#fafafa;">
                    <div><strong>UTC:</strong> <span id="clock-utc">—</span></div>
                    <div><strong>Market (ET):</strong> <span id="clock-market">—</span></div>
                    <div><strong>Local:</strong> <span id="clock-local">—</span></div>
                </div>

                <!-- Daily one-shot supervisor schedule (from logs/schedule.json if present) -->
                <hr>
                <h2>Supervisor Schedule (UTC)</h2>
                <p style="color:#666;margin-top:-6px;">Times below are in UTC and generated once per day by the supervisor.</p>

                {% if schedule %}
                    {% set jobs = status.jobs if status and status.jobs is defined else {} %}
                    {% set hm_obj = jobs.holdings_manager if jobs and jobs.holdings_manager is defined else None %}
                    <!-- NOTE: class changed from 'status-grid' to 'schedule-grid' so JS status updater doesn't target this block -->
                    <div class="schedule-grid">
                        <div><strong>Trading Date:</strong> {{ schedule.trading_date }}</div>
                        <div><strong>Created:</strong> {{ schedule.created_at_utc }}</div>
                        <!-- NEW: Holdings Launch (UTC) surfaced from jobs.holdings_manager -->
                        <div><strong>Holdings (Launched UTC):</strong> {{ hm_obj.last_run_utc if hm_obj and hm_obj.last_run_utc else "—" }}</div>
                        <div><strong>Open:</strong> {{ schedule.open_utc }}</div>

                        {# Holdings after open (fallback to legacy holdings_utc) #}
                        {% set hold_open = schedule.holdings_open_utc if schedule.holdings_open_utc else schedule.holdings_utc %}
                        {% set hold_open_min = schedule.holdings_after_open_min %}
                        <div>
                            <strong>Holdings (after open):</strong>
                            {{ hold_open if hold_open else "—" }}
                            {% if hold_open and hold_open_min is not none %}
                                <span style="color:#666;">(+{{ hold_open_min }}m)</span>
                            {% endif %}
                        </div>

                        <div><strong>Mid:</strong> {{ schedule.mid_utc }}</div>

                        {# Holdings after mid #}
                        {% set hold_mid = schedule.holdings_mid_utc %}
                        {% set hold_mid_min = schedule.holdings_after_mid_min %}
                        <div>
                            <strong>Holdings (after mid):</strong>
                            {{ hold_mid if hold_mid else "—" }}
                            {% if hold_mid and hold_mid_min is not none %}
                                <span style="color:#666;">(+{{ hold_mid_min }}m)</span>
                            {% endif %}
                        </div>

                        <div><strong>Close:</strong> {{ schedule.close_utc }}</div>
                        <div>
                            <strong>Universe (after close):</strong>
                            {{ schedule.universe_utc }}
                            <span style="color:#666;">(+{{ schedule.universe_after_close_min }}m)</span>
                        </div>
                    </div>
                {% else %}
                    <p><em>Schedule not generated yet for today.</em></p>
                    <p><strong>Next run:</strong> tomorrow <code>00:01 UTC</code> (timer)</p>
                {% endif %}

                <!-- ======================== Overview (Balances + Daily P/L) ======================== -->
                <hr>
                <h2>Overview</h2>
                {% set bal = status.account_balances if status and status.account_balances is defined else None %}
                {% set dgl = status.daily_gain_loss if status and status.daily_gain_loss is defined else None %}
                <div class="status-grid">
                    <div><strong>Universe:</strong>
                        {{ status.universe_provider }}
                        — Size: <span style="color:{{ '#b00' if status.universe_size_warn else '#333' }};">
                          {{ status.universe_size }}
                        </span>
                    </div>
                    <div><strong>Account Equity ($):</strong> {{ bal.equity if bal and bal.equity is not none else "—" }}</div>
                    <div><strong>Cash Balance ($):</strong> {{ bal.cash if bal and bal.cash is not none else "—" }}</div>
                    <div><strong>Daily Gain/Loss ($):</strong> {{ dgl.delta if dgl and dgl.delta is not none else "—" }}</div>
                    <div><strong>Balances As Of (UTC):</strong> {{ bal.as_of_utc if bal and bal.as_of_utc else "—" }}</div>
                </div>

                <!-- ======================== RUNTIME GRID ======================== -->
                <hr>
                <div class="status-grid" id="grid-runtime">
                    <div><strong>Running State:</strong> 
                        <span id="status-running-state">
                        {% if status.state == "running" %}
                            <span style="color:green;font-weight:bold;">RUNNING</span>
                        {% elif status.state == "idle" %}
                            <span style="color:orange;font-weight:bold;">IDLE</span>
                        {% elif status.state == "analyzing" %}
                            <span style="color:orange;font-weight:bold;">ANALYZING</span>
                        {% elif status.state == "trading" %}
                            <span style="color:green;font-weight:bold;">TRADING</span>
                        {% elif status.state == "monitoring" %}
                            <span style="color:orange;font-weight:bold;">MONITORING</span>
                        {% elif status.state == "updating" %}
                            <span style="color:orange;font-weight:bold;">UPDATING</span>
                        {% elif status.state == "graceful_closing_positions" %}
                            <span style="color:orange;font-weight:bold;">GRACEFUL CLOSING</span>
                        {% elif status.state == "emergency_closing_positions" %}
                            <span style="color:red;font-weight:bold;">EMERGENCY CLOSING</span>
                        {% elif status.state == "stopped" %}
                            <span style="color:gray;">STOPPED</span>
                        {% elif status.state == "shutdown" %}
                            <span style="color:red;font-weight:bold;">SHUTDOWN</span>
                        {% elif status.state == "shutdown_triggered" %}
                            <span style="color:red;font-weight:bold;">SHUTDOWN</span>
                        {% elif status.state == "error" %}
                            <span style="color:red;font-weight:bold;">ERROR</span>
                        {% else %}
                            <span style="color:gray;">{{ status.state }}</span>
                        {% endif %}
                        </span>
                    </div>
                    <div><strong>Timestamp:</strong> <span id="status-timestamp">{{ status.timestamp }}</span></div>
                    <div><strong>Active Strategy:</strong> <span id="status-active-strategy">{{ status.active_strategy }}</span></div>
                    <div><strong>Trade Count:</strong> <span id="status-trade-count">{{ status.trade_count }}</span></div>
                    <div><strong>Win Trades:</strong> <span id="status-win-trades">{{ status.win_trades }}</span></div>
                    <div><strong>Loss Trades:</strong> <span id="status-loss-trades">{{ status.loss_trades }}</span></div>
                    <div><strong>Win Rate:</strong> <span id="status-win-rate">{{ status.win_rate }}</span>%</div>
                    <div><strong>PnL:</strong> <span id="status-pnl">{{ status.pnl }}</span></div>
                    <div><strong>Error Count:</strong> <span id="status-error-count">{{ status.error_count }}</span></div>
                    <div><strong>Version:</strong> <span id="status-version">{{ status.version }}</span></div>
                </div>

                <!-- ======================== CONSOLIDATED STRATEGY DETAILS ======================== -->
                {% set ss = status.strategy_states if status and status.strategy_states is defined else {} %}
                {% set slr = status.strategy_last_run if status and status.strategy_last_run is defined else {} %}
                {% set enabled_map = status.enabled_strategies if status and status.enabled_strategies is defined else {} %}
                <hr>
                <h2>Strategy Details</h2>
                <div class="cards" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:14px;">
                    {% for label in ["open","mid","close"] %}
                        {% set st = ss[label] if ss and ss[label] is defined else {} %}
                        {% set card = slr[label] if slr and slr[label] is defined else {} %}
                        <div class="card" style="border:1px solid #e2e2e2;border-radius:8px;padding:12px;background:#fff;">
                            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:6px;">
                                <h3 style="margin:0;">{{ label|capitalize }}</h3>
                                {% set state_txt = (st.state if st and st.state else "unknown")|lower %}
                                <span class="chip {{ state_txt }}">{{ state_txt|capitalize }}</span>
                            </div>
                            <div style="font-size:0.95em;color:#333;margin-bottom:8px;">
                                <div><strong>Enabled:</strong> {{ enabled_map[label] if enabled_map and enabled_map[label] is defined else "—" }}</div>
                                {% if label == "open" %}
                                    {% set next_sched = schedule.open_utc if schedule else None %}
                                {% elif label == "mid" %}
                                    {% set next_sched = schedule.mid_utc if schedule else None %}
                                {% else %}
                                    {% set next_sched = schedule.close_utc if schedule else None %}
                                {% endif %}
                                <div><strong>Next Scheduled (UTC):</strong> {{ next_sched if next_sched else "—" }}</div>
                                <div><strong>Last Run UTC:</strong> {{ card.ts_utc if card and card.ts_utc else "—" }}</div>
                                {% if st and st.last_error %}
                                    <div style="color:#b00;margin-top:6px;"><strong>Last Error:</strong> {{ st.last_error }}</div>
                                {% endif %}
                            </div>

                            <div style="margin-top:8px;">
                                <strong>Last Candidates</strong>
                                {% set cand = card.candidates if card and card.candidates else [] %}
                                {% if cand and cand|length > 0 %}
                                    <ul style="margin:6px 0 0 18px;">
                                        {% for c in cand %}
                                            <li>
                                                {{ c.symbol or c.get("symbol") }}
                                                {% if c.score is defined %}<small style="color:#666;">(score {{ c.score }})</small>{% endif %}
                                                {% if c.signal is defined and c.signal %}<small style="color:#666;">– {{ c.signal }}</small>{% endif %}
                                            </li>
                                        {% endfor %}
                                    </ul>
                                {% else %}
                                    <div style="color:#666;"><em>No snapshot.</em></div>
                                {% endif %}
                            </div>

                            <div style="margin-top:8px;">
                                <strong>Last Trades</strong>
                                {% set tr = card.trades if card and card.trades else {} %}
                                <div style="display:grid;grid-template-columns:repeat(2,minmax(80px,1fr));gap:6px;margin-top:4px;">
                                    <div>Count: {{ tr.count if tr and tr.count is defined else 0 }}</div>
                                    <div>Wins: {{ tr.wins if tr and tr.wins is defined else 0 }}</div>
                                    <div>Losses: {{ tr.losses if tr and tr.losses is defined else 0 }}</div>
                                    <div>Realized PnL: {{ tr.realized_pnl if tr and tr.realized_pnl is defined else 0.0 }}</div>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>

                <!-- ======================== JOBS ======================== -->
                <hr>
                <h2>Jobs</h2>
                {% set jobs2 = status.jobs if status and status.jobs is defined else {} %}
                <div class="status-grid">
                    {% set hm2 = jobs2.holdings_manager if jobs2 and jobs2.holdings_manager is defined else {} %}
                    <div><strong>Holdings Manager:</strong> {{ hm2.last_run_utc if hm2 and hm2.last_run_utc else "—" }} <span style="color:#666;">({{ hm2.status if hm2 and hm2.status else "—" }})</span></div>
                    {% set ur = jobs2.universe_rebuild if jobs2 and jobs2.universe_rebuild is defined else {} %}
                    <div><strong>Universe Rebuild:</strong> {{ ur.last_run_utc if ur and ur.last_run_utc else "—" }} <span style="color:#666;">({{ ur.status if ur and ur.status else "—" }})</span></div>
                </div>

                <!-- ======================== RISK CONTROLS ======================== -->
                <hr>
                <h2>Risk Controls</h2>
                {% set rc = status.risk_controls if status and status.risk_controls is defined else {} %}
                <div class="status-grid" id="grid-risk">
                    <div><strong>Max Risk per Trade:</strong> <span id="status-max-risk">{{ rc.max_risk_per_trade if rc and rc.max_risk_per_trade is not none else "—" }}</span></div>
                    <div><strong>Daily Loss Limit:</strong> <span id="status-daily-loss">{{ rc.daily_loss_limit if rc and rc.daily_loss_limit is not none else "—" }}</span></div>
                </div>

                <!-- ======================== CANDIDATE/ELIGIBILITY TABLE ======================== -->
                <hr>
                <h2>Candidate Selection & Fallback Status</h2>
                {% if candidate_status %}
                    <table class="status-table">
                        <thead>
                            <tr>
                                <th>Symbol</th>
                                <th>Strategy</th>
                                <th>Status</th>
                                <th>Fallback Used</th>
                                <th>Broker Eligibility</th>
                                <th>Reason</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for candidate in candidate_status %}
                                <tr>
                                    <td>{{ candidate.symbol }}</td>
                                    <td>{{ candidate.strategy }}</td>
                                    <td>{{ candidate.status }}</td>
                                    <td>{{ candidate.fallback }}</td>
                                    <td>{{ candidate.broker_eligibility }}</td>
                                    <td>{{ candidate.reason }}</td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                {% else %}
                    <p>No candidate data available.</p>
                {% endif %}

            {% endif %}
        </div>
    </div>
</body>
</html>
