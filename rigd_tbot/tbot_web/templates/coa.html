<!-- tbot_web/templates/coa.html -->
<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>TradeBot Chart of Accounts (COA) Management</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="stylesheet" href="/static/css/base/normalize.css">
        <link rel="stylesheet" href="/static/css/base/layout.css">
        <link rel="stylesheet" href="/static/css/shared/forms.css">
        <link rel="stylesheet" href="/static/css/components/buttons.css">
        <link rel="stylesheet" href="/static/css/pages/coa.css">
        <style>
            .coa-row { display: flex; align-items: center; margin-bottom: 6px; }
            .coa-row input { margin-right: 8px; }
            .coa-children { margin-left: 28px; }
            .coa-actions button { margin-left: 4px; }
            #coa-edit-area { margin-top: 18px; }
            #coa-save-bar { margin-top: 12px; }
            #coa-metadata-table td { padding: 4px 6px; }
            .muted { color:#666; font-size:.9em; }
            pre { white-space: pre-wrap; word-break: break-word; }
        </style>
    </head>
<body>
    <div class="container">
        <header>
            <h1>Chart of Accounts (COA) Management</h1>
            <nav>
                <a href="{{ url_for('main.main_page') }}">Dashboard</a> |
                <a href="{{ url_for('settings_web.settings_page') }}">Bot Settings</a> |
                <a href="{{ url_for('logs_web.logs_page') }}">Logs</a> |
                <a href="{{ url_for('coa_web.coa_management') }}">COA</a>
            </nav>
        </header>

        {% if error %}
            <div class="error-message" style="color: #c00; margin-bottom: 2em;">
                {{ error }}
            </div>
        {% endif %}

        <section>
            <h2>COA Metadata</h2>
            <table id="coa-metadata-table">
                <tbody>
                    <tr><td>Version</td><td id="version_id"></td></tr>
                    <tr><td>Currency Code</td><td id="currency_code"></td></tr>
                    <tr><td>Entity Code</td><td id="entity_code"></td></tr>
                    <tr><td>Jurisdiction Code</td><td id="jurisdiction_code"></td></tr>
                    <tr><td>Created (UTC)</td><td id="created_at_utc"></td></tr>
                    <tr><td>Last Updated (UTC)</td><td id="last_updated_utc"></td></tr>
                </tbody>
            </table>
            <p class="muted">Structure editor only. COA <em>mapping</em> is managed separately.</p>
        </section>

        <section>
            <h2>Account Hierarchy</h2>
            <div id="coa-tree">
                <!-- Editable Account Hierarchy UI (read-only view below; editor for admins further down) -->
            </div>
            <div id="coa-export-controls" style="margin-top:.75rem;">
                <form method="get" action="{{ url_for('coa_web.coa_export_markdown') }}" style="display:inline;">
                    <button type="submit">Export as Markdown</button>
                </form>
                <form method="get" action="{{ url_for('coa_web.coa_export_csv') }}" style="display:inline;margin-left:.5rem;">
                    <button type="submit">Export as CSV</button>
                </form>
            </div>

            {% if user_is_admin %}
            <div id="coa-edit-area">
                <button id="edit-coa-btn" onclick="toggleEditMode();return false;">Edit COA</button>
                <div id="coa-editor" style="display:none;">
                    <div id="coa-editor-tree"></div>
                    <div id="coa-save-bar">
                        <form id="coa-edit-form" method="post" action="{{ url_for('coa_web.coa_edit') }}">
                            <input type="hidden" name="coa_json" id="coa_json">
                            <button type="button" onclick="saveCoaEdits()">Save Changes</button>
                            <button type="button" onclick="toggleEditMode()">Cancel</button>
                        </form>
                    </div>
                </div>
            </div>
            {% endif %}
        </section>

        <section>
            <h2>COA Change History (Audit Log)</h2>
            <div id="coa-history">
                <table>
                    <thead>
                        <tr>
                            <th>Timestamp (UTC)</th>
                            <th>User</th>
                            <th>Change Summary</th>
                            <th>Diff Preview</th>
                        </tr>
                    </thead>
                    <tbody id="coa-history-table">
                        <!-- Change log will be rendered here -->
                    </tbody>
                </table>
            </div>
        </section>

        <footer>
            <small>RIGD GROUP LLC â€” TradeBot v038 | UTC <span id="utc-time"></span></small>
        </footer>
    </div>

    <script>
        // UTC clock
        function updateUTC() {
            const now = new Date();
            const el = document.getElementById("utc-time");
            if (el) el.textContent = now.toISOString().replace("T", " ").slice(0,19);
        }
        setInterval(updateUTC, 1000);
        updateUTC();

        let coaData = null;
        let editMode = false;

        // Fetch and render COA + metadata
        document.addEventListener("DOMContentLoaded", function() {
            fetch('{{ url_for("coa_web.coa_api") }}')
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        document.getElementById("coa-metadata-table").innerHTML =
                          "<tr><td colspan='2' style='color:#c00;'>" + (data.error || "COA unavailable") + "</td></tr>";
                        document.getElementById("coa-tree").innerHTML = "";
                        document.getElementById("coa-history-table").innerHTML = "";
                        return;
                    }

                    const meta = data.metadata || {};
                    // Metadata
                    setText("version_id", meta.version_id || "");
                    setText("currency_code", meta.currency_code || "");
                    setText("entity_code", meta.entity_code || "");
                    setText("jurisdiction_code", meta.jurisdiction_code || "");
                    setText("created_at_utc", meta.created_at_utc || "");
                    setText("last_updated_utc", meta.last_updated_utc || "");

                    // Hierarchy (read-only)
                    coaData = data.accounts || [];
                    document.getElementById("coa-tree").innerHTML = buildCoaTreeHtml(coaData);

                    // History
                    const history = data.history || [];
                    const historyTable = document.getElementById("coa-history-table");
                    historyTable.innerHTML = history.map(item => `
                        <tr>
                            <td>${safe(item.timestamp_utc)}</td>
                            <td>${safe(item.user)}</td>
                            <td>${safe(item.summary)}</td>
                            <td><pre>${safe(item.diff)}</pre></td>
                        </tr>
                    `).join('');
                })
                .catch(err => {
                    console.error("COA load failed", err);
                    document.getElementById("coa-metadata-table").innerHTML =
                      "<tr><td colspan='2' style='color:#c00;'>Failed to load COA metadata</td></tr>";
                });
        });

        function setText(id, v){ const el = document.getElementById(id); if(el) el.textContent = v; }
        function safe(v){ return (v === undefined || v === null) ? "" : String(v); }

        // Render COA account tree for display (read-only)
        function buildCoaTreeHtml(accounts) {
            function render(accs, depth=0) {
                return (accs || []).map(acc => `
                    <div style="margin-left: ${depth * 20}px;">
                        <strong>${safe(acc.code)}</strong> â€” ${safe(acc.name)}
                        ${acc.children ? render(acc.children, depth + 1) : ''}
                    </div>
                `).join('');
            }
            return render(accounts);
        }

        // Editable tree for admins
        function renderCoaEditor(accounts, parent, depth=0) {
            (accounts || []).forEach((acc, idx) => {
                const row = document.createElement('div');
                row.className = 'coa-row';
                row.style.marginLeft = (depth * 20) + "px";

                // Code
                const code = document.createElement('input');
                code.type = "text";
                code.value = acc.code || '';
                code.size = 10;
                code.placeholder = "Code";
                code.onchange = () => acc.code = code.value.trim();
                row.appendChild(code);

                // Name
                const name = document.createElement('input');
                name.type = "text";
                name.value = acc.name || '';
                name.size = 28;
                name.placeholder = "Name";
                name.onchange = () => acc.name = name.value;
                row.appendChild(name);

                // Delete button
                const del = document.createElement('button');
                del.textContent = "ðŸ—‘";
                del.title = "Delete account";
                del.onclick = function() {
                    accounts.splice(idx, 1);
                    renderCoaEditorUI();
                };
                row.appendChild(del);

                // Add child button
                const addChild = document.createElement('button');
                addChild.textContent = "+";
                addChild.title = "Add child account";
                addChild.onclick = function() {
                    if(!acc.children) acc.children = [];
                    acc.children.push({code:"",name:""});
                    renderCoaEditorUI();
                };
                row.appendChild(addChild);

                parent.appendChild(row);

                // Children
                if(Array.isArray(acc.children) && acc.children.length){
                    const kids = document.createElement('div');
                    kids.className = "coa-children";
                    row.appendChild(kids);
                    renderCoaEditor(acc.children, kids, depth+1);
                }
            });

            // Add sibling at root
            if(depth===0){
                const addRoot = document.createElement('button');
                addRoot.textContent = "+ Add Top-level Account";
                addRoot.onclick = function() {
                    accounts.push({code:"",name:""});
                    renderCoaEditorUI();
                };
                parent.appendChild(addRoot);
            }
        }

        function renderCoaEditorUI() {
            const area = document.getElementById('coa-editor-tree');
            area.innerHTML = '';
            renderCoaEditor(coaData, area, 0);
        }

        // Toggle between view/edit mode
        function toggleEditMode() {
            editMode = !editMode;
            document.getElementById('coa-editor').style.display = editMode ? "block" : "none";
            document.getElementById('edit-coa-btn').textContent = editMode ? "Cancel Edit" : "Edit COA";
            if(editMode) renderCoaEditorUI();
        }

        // Save COA edits via hidden field and submit
        function saveCoaEdits() {
            try {
                document.getElementById('coa_json').value = JSON.stringify(coaData || [], null, 2);
                document.getElementById('coa-edit-form').submit();
            } catch (e) {
                alert('Failed to serialize COA JSON: ' + e);
            }
        }
    </script>
</body>
</html>
